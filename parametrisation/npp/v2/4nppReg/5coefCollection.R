cc <- matrix(NA, nrow=16, ncol=11)


cc[1,] <- c(6.94357e-06,8,1.15427,300,2.38,0.025,0.8,50,0.002,0.85,20)#lc1er1
cc[2,] <- c(6.97374e-07,8,2.08263,300,2.36,0.025,0.6,50,0.002,0.85,20)#lc2er1
cc[3,] <- c(4.98896e-09,4,3.3326,300,3,0.04,0.8,50,0.002,0.85,20) #lc3er1
cc[4,] <- c(3.17454e-07,8,1.98803,300,1.82,0.025,0.42,50,0.002,0.85,20)#lc4er1
cc[5,] <- c(2.98529e-07,8,2.52942,300,5,0.025,0.8,50,0.002,0.85,20)#lc1er2
cc[6,] <- c(3.68661e-07,8,2.4796,300,3.4,0.025,0.6,50,0.002,0.85,20)#lc2er2
cc[7,] <- c(2.78094e-06,4,1.46148,300,3,0.04,0.8,50,0.002,0.85,20)#lc3er2
cc[8,] <- c(5.22354e-08,3.81171,2.94545,300,3.18175,0.0232828,0.809172,50,0.002,0.851749,20)#lc4er2
cc[9,] <- c(1.95866e-11,16.6774,5.30899,300,7.00127,0.0828,0.180158,50,0.002,0.85,20)#lc1er3
#cc[10,] <- c(3.99765e-05,3.05402,1.04369,300,3.11701,0.06,0.2,50,0.002,0.85,20)#lc2er3
cc[10,] <- c(3.15e-09,9.35918,3.66485,300,4.64592,0.06,0.26,50,0.002,0.85,20)#0.5 * lc4er3
cc[11,] <- c(1.50349e-07,7.07274,2.54163,300,4.00133,0.06,0.25,50,0.002,0.85,20)#lc3er3
cc[12,] <- c(6.30082e-09,9.35918,3.66485,300,4.64592,0.06,0.26,50,0.002,0.85,20)#lc4er3
cc[13,] <- c(1.36116e-07,6.7432,2.82955,300,4.57307,0.06,0.50,50,0.002,0.85,20)#lc1er4
#cc[14,] <- c(1.12058e-06,4.3106,2.48811,300,5.28351,0.06,0.64,50,0.002,0.85,20)#lc2er4
cc[14,] <- c(6.94485e-11,10.3926,5.18179,300,8.21249,0.06,0.2,50,0.002,0.85,20)#0.5 * lc3er4
cc[15,] <- c(7.54653e-07,3.39758,2.39893,300,5.10519,0.06,0.59,50,0.002,0.85,20)#lc3er4
cc[16,] <- c(1.38897e-10,10.3926,5.18179,300,8.21249,0.06,0.2,50,0.002,0.85,20)#lc3er4

cs <- matrix(NA, nrow=16, ncol=23)

cs[1,] <- c(1.167273,1.181957,1.148051,1.144072,1.057347,1.183415,0.839456,0.998758,1.066749,0.998820,0.888920,1.132417,1.070195,1.146386,1.444292,1.338450,0.926202,1.164307,1.482320,1.161192,1.119969,1.010927,1.126816)
cs[2,] <- c(1.027236,0.930810,1.026614,1.058107,1.044301,1.088828,1.284784,0.997171,1.030403,0.930521,0.917611,1.071603,1.167654,1.063758,1.260789,1.139207,0.999577,0.966556,1.161625,0.990053,1.105658,1.056113,1.107417)
cs[3,] <- c(1.25067,1.30666,1.42140,1.37749,1.19130,1.15079,0.42130,1.41935,1.35999,1.15866,1.22622,1.17439,1.46707,1.43959,1.89361,1.66058,1.01811,1.55586,1.65774,1.17218,1.36042,1.39463,1.66056)
cs[4,] <- c(1.014203,0.655291,0.932896,1.681138,0.909431,0.724058,1.170861,0.730898,0.584047,0.946718,0.868518,0.866705,0.973624,1.075178,2.262815,0.867673,0.700617,0.794007,1.981404,1.001099,1.352024,1.284358,1.225052)
cs[5,] <- c(1.084565,1.258374,1.544269,1.208804,1.048047,1.152335,0.798060,1.058165,1.172564,1.078057,1.483471,1.160240,1.351295,1.353240,1.784506,1.224317,1.034672,1.308062,1.714973,1.010345,1.210056,1.215814,0.994749)
cs[6,] <- c(1.0392105,0.9697758,1.1182245,1.0074064,0.9719184,0.9856556,0.8268068,0.9808688,1.0001164,0.9635926,1.0681479,1.0059678,1.2294432,1.0322276,1.0641367,0.9296392,1.0646439,1.1399712,1.0061634,1.1424225,0.9144326,1.1622985,1.0073817)
cs[7,] <- c(1.33731,1.21174,2.09552,1.45462,1.11848,1.78982,0.44737,1.14455,1.33598,1.16703,1.59218,1.89613,1.54779,1.33450,1.61385,1.23386,1.15095,1.48598,1.50806,1.13044,1.04776,1.27060,1.15392)
cs[8,] <- c(0.983435,1.216336,1.208377,1.164035,1.127213,1.427934,0.427887,1.041255,0.899436,0.951187,1.505357,1.606139,1.512237,1.196615,1.284658,1.063652,1.121445,1.179302,1.375756,0.836196,1.106857,1.427041,1.055856)
cs[9,] <- c(1.054684,1.099922,1.075196,0.980570,1.002155,1.044522,1.134524,1.073864,1.000548,1.070339,1.068615,1.086483,1.054495,1.036821,1.095323,1.008207,1.094867,1.031270,0.987843,1.035130,0.950606,1.074587,1.008381)
cs[10,] <- c(1.0118956,1.0615462,1.0779899,1.0120382,0.9627487,0.9898199,1.0791497,1.0310722,0.9754276,0.8438813,1.1233655,1.1068356,1.0901310,1.0101304,1.0565290,1.0779955,1.0621784,1.0007144,0.9295641,1.0472222,1.0161400,1.0173837,1.0171552)
cs[11,] <- c(0.862190,1.145883,1.135764,0.950486,1.102457,1.030473,0.956814,0.975896,1.170444,1.003162,1.169161,1.053181,1.126635,1.232963,0.864202,1.179097,0.774995,0.995233,1.321486,1.032954,1.041349,1.029158,1.056834)
cs[12,] <- c(0.8426849,1.1336508,0.9219486,1.0428545,1.1223109,0.8339236,1.0641686,0.5452793,1.0681361,1.0280533,1.0013517,0.6224940,1.2335694,1.1491972,1.0465842,0.9879109,1.1978397,0.9430111,1.0909037,1.1027924,1.0124663,1.2082930,1.0756028)
cs[13,] <- c(1.035657,1.036384,1.032846,1.030142,1.055238,1.052846,1.045243,1.024852,1.002326,0.998242,1.081536,1.108310,1.013428,1.036258,1.054235,1.041855,1.031564,1.027304,1.115472,1.011239,1.016438,1.006963,1.013799)
cs[14,] <- c(0.93566,1.04938,0.99955,1.17027,0.92923,0.90336,1.00938,1.02759,0.95376,0.90328,1.00736,0.99617,1.14578,1.09325,1.25368,1.11511,0.92586,0.99376,1.10367,0.90914,0.96348,0.94270,1.41604)
cs[15,] <- c(0.997382,1.164807,1.137406,1.157535,1.025785,1.016309,0.922417,1.078434,1.033414,0.960146,1.018151,1.064526,1.083873,1.061930,1.108677,1.053499,1.025711,0.942647,1.277620,1.014716,1.114794,1.009307,1.115872)
cs[16,] <- c(0.816807,1.171890,1.106970,1.007987,0.960848,0.923770,1.029693,1.114420,1.059554,1.006887,1.168652,0.913977,1.082629,1.532929,1.053006,1.072970,0.989127,0.994642,1.297751,0.959316,1.233419,0.953433,1.041302)

cs[cs<0.8] <- 0.8
cs[cs>1.2] <- 1.2




par(mfcol=c(4,4))

h <- 400
nT <- 365
rad <- 3
t <- -10:35
aux <- 0

for(i in 1:16) {
    p <- 999
plot(t, cc[i,1]*exp(-h/7990)*nT*rad*pmax(0, (cc[i,2]+t))^cc[i,3] * pmax(0, 1 - 30*exp(17.62*t/(243.12 + t)) / tanh(cc[i,6]*p) / cc[i,4])^cc[i,5], type="l", main = i, ylab="NPP")
for(j in 1:8) {
  p <- pmax(0, j*10 - cc[i,11] - cc[i,8] * tanh(cc[i,9] * 30*exp(17.62*t/(243.12 + t))))
  lines(t, cc[i,1]*exp(-h/7990)*nT*rad*pmax(0, (cc[i,2]+t))^cc[i,3] * pmax(0, 1 - 30*exp(17.62*t/(243.12 + t)) / tanh(cc[i,6]*p) / cc[i,4])^cc[i,5], col=j)
}
}


x <- read.table("/data/tmp/baseData30.txt")
names(x) <- c("x","y","landcover","npp","npp01","npp02","npp03","npp04","npp05","npp06","npp07","npp08","npp09","npp10","npp11","npp12","ecoRegionFao","soilIiasaFao90","soilIiasaSwr","soilIiasaAwc","elevation","prec01","prec02","prec03","prec04","prec05","prec06","prec07","prec08","prec09","prec10","prec11","prec12","tmean01","tmean02","tmean03","tmean04","tmean05","tmean06","tmean07","tmean08","tmean09","tmean10","tmean11","tmean12","radi01","radi02","radi03","radi04","radi05","radi06","radi07","radi08","radi09","radi10","radi11","radi12")

x$soilIiasaAwc[x$soilIiasaAwc < 0] <- NA
x$soilIiasaSwr[x$soilIiasaSwr < 0] <- NA
#estimate awc and swr from soiltype
modalwert <- function(a) {max(0,as.integer(names(which.max(table(a)))))}
t1 <- with(x, tapply(soilIiasaAwc, soilIiasaFao90 , modalwert))
x$soilIiasaAwc[is.na(x$soilIiasaAwc)] <- t1[as.character(x$soilIiasaFao90[is.na(x$soilIiasaAwc)])]
x$soilIiasaAwc[x$soilIiasaAwc == 0] <- NA
t1 <-modalwert(x$soilIiasaAwc)
x$soilIiasaAwc[is.na(x$soilIiasaAwc)] <- t1
t1 <- with(x, tapply(soilIiasaSwr, soilIiasaFao90 , modalwert))
x$soilIiasaSwr[is.na(x$soilIiasaSwr)] <- t1[as.character(x$soilIiasaFao90[is.na(x$soilIiasaSwr)])]
x$soilIiasaSwr[x$soilIiasaSwr == 0] <- NA
t1 <-modalwert(x$soilIiasaSwr)
x$soilIiasaSwr[is.na(x$soilIiasaSwr)] <- t1
rm(t1)
gc()

sort(table(x$soilIiasaFao90))
createSoilGroups <- function() {
  t1 <- rep(NA, NROW(x))
  t1[x$soilIiasaFao90 >= 1 & x$soilIiasaFao90 < 9] <- 1
  t1[x$soilIiasaFao90 >= 9 & x$soilIiasaFao90 < 18] <- 2
  t1[x$soilIiasaFao90 >= 18 & x$soilIiasaFao90 < 24] <- 3
  t1[x$soilIiasaFao90 >= 24 & x$soilIiasaFao90 < 31] <- 4
  t1[x$soilIiasaFao90 >= 31 & x$soilIiasaFao90 < 38] <- 5
  t1[x$soilIiasaFao90 >= 38 & x$soilIiasaFao90 < 46] <- 6
  t1[x$soilIiasaFao90 >= 46 & x$soilIiasaFao90 < 51] <- 7
  t1[x$soilIiasaFao90 >= 51 & x$soilIiasaFao90 < 57] <- 8
  t1[x$soilIiasaFao90 >= 57 & x$soilIiasaFao90 < 61] <- 9
  t1[x$soilIiasaFao90 >= 61 & x$soilIiasaFao90 < 71] <- 10
  t1[x$soilIiasaFao90 >= 71 & x$soilIiasaFao90 < 78] <- 11
  t1[x$soilIiasaFao90 >= 78 & x$soilIiasaFao90 < 81] <- 12
  t1[x$soilIiasaFao90 >= 81 & x$soilIiasaFao90 < 86] <- 13
  t1[x$soilIiasaFao90 >= 86 & x$soilIiasaFao90 < 92] <- 14
  t1[x$soilIiasaFao90 >= 92 & x$soilIiasaFao90 < 97] <- 15
  t1[x$soilIiasaFao90 >= 97 & x$soilIiasaFao90 < 105] <- 16
  t1[x$soilIiasaFao90 >= 105 & x$soilIiasaFao90 < 114] <- 17
  t1[x$soilIiasaFao90 >= 114 & x$soilIiasaFao90 < 121] <- 18
  t1[x$soilIiasaFao90 >= 121 & x$soilIiasaFao90 < 125] <- 19
  t1[x$soilIiasaFao90 >= 125 & x$soilIiasaFao90 < 131] <- 20
  t1[x$soilIiasaFao90 >= 131 & x$soilIiasaFao90 < 137] <- 21 
  t1[x$soilIiasaFao90 >= 137 & x$soilIiasaFao90 < 143] <- 22
  t1[x$soilIiasaFao90 >= 143 & x$soilIiasaFao90 < 148] <- 23
  t1[x$soilIiasaFao90 >= 148 & x$soilIiasaFao90 < 155] <- 24
  t1[x$soilIiasaFao90 >= 155 & x$soilIiasaFao90 < 162] <- 25
  t1[x$soilIiasaFao90 >= 162 & x$soilIiasaFao90 < 170] <- 26
  t1[x$soilIiasaFao90 >= 170 & x$soilIiasaFao90 < 177] <- 27
  t1[x$soilIiasaFao90 >= 177 & x$soilIiasaFao90 < 182] <- 28
  t1[x$soilIiasaFao90 >= 182] <- 29
  t1[x$soilIiasaFao90 == 63] <- 30
  t1[x$soilIiasaFao90 == 65] <- 31
  t1[x$soilIiasaFao90 == 12] <- 32
  t1[x$soilIiasaFao90 == 196] <- 33
  t1[x$soilIiasaFao90 == 103] <- 34
  t1[x$soilIiasaFao90 == 153] <- 35
  t1[x$soilIiasaFao90 == 106] <- 36
  t1[x$soilIiasaFao90 == 161] <- 37
  t1[x$soilIiasaFao90 == 17] <- 38
  t1[x$soilIiasaFao90 == 62] <- 39
  t1[x$soilIiasaFao90 == 151] <- 40
#
#sort(table(t1))
  t2 <- rep(1, NROW(x))
  t2[t1 == 24] <- 2
  t2[t1 == 6] <- 3
  t2[t1 == 30] <- 4
  t2[t1 == 20] <- 5
  t2[t1 == 31] <- 6
  t2[t1 == 1] <- 7
  t2[t1 == 32] <- 8
  t2[t1 == 25] <- 9
  t2[t1 == 33] <- 10
  t2[t1 == 2] <- 11
  t2[t1 == 21] <- 12
  t2[t1 == 34] <- 13
  t2[t1 == 35] <- 14
  t2[t1 == 16] <- 15
  t2[t1 == 14] <- 16
  t2[t1 == 36] <- 17
  t2[t1 == 17] <- 18
  t2[t1 == 37] <- 19
  t2[t1 == 10] <- 20
  t2[t1 == 38] <- 21
  t2[t1 == 39] <- 22
  t2[t1 == 40] <- 23
  t2
}
x$soil <- createSoilGroups()
gc()
table(x$soil)

x$npp <- x$npp/1000 #tC/ha/Year
x$npp01 <- x$npp01/1000 #tC/ha/month
x$npp02 <- x$npp02/1000
x$npp03 <- x$npp03/1000
x$npp04 <- x$npp04/1000
x$npp05 <- x$npp05/1000
x$npp06 <- x$npp06/1000
x$npp07 <- x$npp07/1000
x$npp08 <- x$npp08/1000
x$npp09 <- x$npp09/1000
x$npp10 <- x$npp10/1000
x$npp11 <- x$npp11/1000
x$npp12 <- x$npp12/1000
gc()

x$radi01 <- x$radi01*1000/(24*60*60) #(kJ m-2 day-1) to W/m2
x$radi02 <- x$radi02*1000/(24*60*60)
x$radi03 <- x$radi03*1000/(24*60*60)
x$radi04 <- x$radi04*1000/(24*60*60)
x$radi05 <- x$radi05*1000/(24*60*60)
x$radi06 <- x$radi06*1000/(24*60*60)
x$radi07 <- x$radi07*1000/(24*60*60)
x$radi08 <- x$radi08*1000/(24*60*60)
x$radi09 <- x$radi09*1000/(24*60*60)
x$radi10 <- x$radi10*1000/(24*60*60)
x$radi11 <- x$radi11*1000/(24*60*60)
x$radi12 <- x$radi12*1000/(24*60*60)
gc()

whc <- c(150,125,100,75,50,15,0)*1.5  #Water holding capacity
x$whc <- whc[x$soilIiasaAwc]

nTage <- c(31,28.25,31,30,31,30,31,31,30,31,30,31)

library(Rcpp)
Sys.setenv("PKG_CXXFLAGS"="-Wall -O3 -ffast-math -march=native -funroll-loops -flto -std=c++11")
sourceCpp("../nppModel.cc")

library(raster)

t3 <- rasterFromXYZ(data.frame(x$x, x$y, x$npp))
plot(t3)

i <- 9
t1 <- with(x, nppMod8(cc[i,], nTage, rbind(tmean01,tmean02,tmean03,tmean04,tmean05,tmean06,tmean07,tmean08,tmean09,tmean10,tmean11,tmean12), rbind(prec01,prec02,prec03,prec04,prec05,prec06,prec07,prec08,prec09,prec10,prec11,prec12), rbind(radi01,radi02,radi03,radi04,radi05,radi06,radi07,radi08,radi09,radi10,radi11,radi12), elevation, whc))
t2 <- rowSums(matrix(t1, ncol=12, byrow=T))
t3 <- rasterFromXYZ(data.frame(x$x, x$y, t2))
plot(t3)

t3 <- rasterFromXYZ(data.frame(x$x, x$y, t2*cs[i,x$soil]))
plot(t3)
